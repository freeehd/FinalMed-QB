const jQuery=window.jQuery;jQuery(document).ready(i=>{const n=i("#wqb-review-incorrect-root"),h=window.wqb_data.ajax_url,q=window.wqb_data.nonce,s={questions:[],currentIndex:0,totalQuestions:0,selectedCategories:[]};n.on("click","#wqb-review-next",()=>p("next")),n.on("click","#wqb-review-prev",()=>p("prev")),n.on("click","#wqb-review-return-dashboard",()=>{window.location.href="/staging-area"}),n.on("click",".wqb-category-toggle",function(t){t.preventDefault();const e=i(this),r=e.closest(".wqb-category-row").siblings(".wqb-category-children");e.toggleClass("open"),e.hasClass("open")?e.text("-"):e.text("+"),r.slideToggle(200)}),n.on("change",".wqb-category-checkbox-parent, .wqb-category-checkbox-child",function(){const t=i(this),e=t.hasClass("wqb-category-checkbox-parent"),r=t.prop("checked");if(e)t.closest(".wqb-category-item").find('.wqb-category-children input[type="checkbox"]').prop("checked",r);else{r||t.closest(".wqb-category-children").siblings(".wqb-category-row").find(".wqb-category-checkbox-parent").prop("checked",!1);const o=t.closest(".wqb-category-children").find(".wqb-category-checkbox-child");o.length>0&&o.get().every(c=>i(c).prop("checked"))&&t.closest(".wqb-category-children").siblings(".wqb-category-row").find(".wqb-category-checkbox-parent").prop("checked",!0)}f()}),n.on("click","#wqb-reset-progress",C);function d(){n.find(".wqb-review-main-content .wqb-review-view").html('<div class="wqb-loader">Loading incorrectly answered questions...</div>'),i.ajax({url:h,type:"POST",data:{action:"wqb_get_incorrect_questions",nonce:q,categories:s.selectedCategories},dataType:"json",success:t=>{t.success&&t.data.questions&&t.data.questions.length>0?(s.questions=t.data.questions,s.totalQuestions=t.data.questions.length,s.currentIndex=0,g(s.currentIndex)):n.find(".wqb-review-main-content .wqb-review-view").html(`
                      <div class="wqb-review-empty">
                          <h2>No Incorrect Questions Found</h2>
                          <p>It looks like you haven't answered any questions incorrectly yet, or no questions match your selected categories.</p>
                          <button id="wqb-review-return-dashboard" class="wqb-button-primary">Return to Dashboard</button>
                      </div>
                  `)},error:(t,e,r)=>{console.error("AJAX Error fetching incorrect questions:",{xhr:t,status:e,error:r}),n.find(".wqb-review-main-content .wqb-review-view").html(`
                  <div class="wqb-error">
                      <h3>Error Loading Questions</h3>
                      <p>There was a problem fetching your incorrect questions. Please try again later.</p>
                      <button id="wqb-review-return-dashboard" class="wqb-button-primary">Return to Dashboard</button>
                  </div>
              `)}})}function y(){i.ajax({url:h,type:"POST",data:{action:"wqb_get_review_categories",nonce:q},dataType:"json",success:t=>{if(t.success){const e=t.data.category_tree;m(),k(e),d()}else console.error("Failed to fetch categories:",t.data.message),d()},error:(t,e,r)=>{console.error("AJAX Error fetching categories:",{xhr:t,status:e,error:r}),d()}})}function f(){s.selectedCategories=[],n.find('.wqb-category-filter input[type="checkbox"]:checked').each(function(){s.selectedCategories.push(Number.parseInt(i(this).val()))}),d()}function m(){n.html(`
          <div class="wqb-review-page-container">
              <div class="wqb-breadcrumb-navigation">
                  <div class="wqb-breadcrumb-container">
                      <button class="wqb-breadcrumb-btn wqb-button-secondary" onclick="window.location.href='/staging-area'">
                          <span class="wqb-button-icon">
                              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                  <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                  <polyline points="9,22 9,12 15,12 15,22" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                              </svg>
                          </span>
                          Home
                      </button>
                      <div class="wqb-breadcrumb-separator">\u203A</div>
                      <span class="wqb-breadcrumb-current">Incorrect Questions Review</span>
                  </div>
              </div>
              
              <div class="wqb-review-sidebar">
                  <div class="wqb-review-sidebar-header">
                      <h3>Filter by Category</h3>
                  </div>
                  <div id="wqb-category-filter" class="wqb-category-filter">
                      <!-- Categories will be rendered here -->
                  </div>
                  <div class="wqb-review-sidebar-footer">
                      <button id="wqb-review-return-dashboard" class="wqb-button-secondary">Return to Home</button>
                      <button id="wqb-reset-progress" class="wqb-button-danger">Reset All Progress</button>
                  </div>
              </div>
              <div class="wqb-review-main-content">
                  <div class="wqb-review-view">
                      <!-- Question content will be rendered here -->
                  </div>
              </div>
          </div>
      `)}function k(t){function e(o,a=0){let c=`<ul class="wqb-category-tree-level-${a}">`;return!o||o.length===0?"":(o.forEach(l=>{const w=l.children&&l.children.length>0,b=s.selectedCategories.includes(l.id)?"checked":"";c+=`<li class="wqb-category-item">
                              <div class="wqb-category-row">
                                  ${w?'<a href="#" class="wqb-category-toggle">+</a>':'<span class="wqb-category-toggle-placeholder"></span>'}
                                  <label>
                                      <input type="checkbox" class="${w?"wqb-category-checkbox-parent":"wqb-category-checkbox-child"}" name="wqb_categories[]" value="${l.id}" ${b}>
                                      ${l.name}
                                  </label>
                              </div>`,w&&(c+=`<div class="wqb-category-children">${e(l.children,a+1)}</div>`),c+="</li>"}),c+="</ul>",c)}const r=e(t);i("#wqb-category-filter").html(r),n.find(".wqb-category-checkbox-child:checked").each(function(){i(this).closest(".wqb-category-children").show().siblings(".wqb-category-row").find(".wqb-category-toggle").addClass("open").text("-")})}function g(t){if(t<0||t>=s.totalQuestions){console.error("Invalid question index for review:",t);return}s.currentIndex=t;const e=s.questions[t],r=Array.isArray(e.options)?e.options:[],o=Number.isInteger(e.user_answer_index)?e.user_answer_index:null,a=Number.isInteger(e.correct_choice_index)?e.correct_choice_index:null,c=o!==null&&a!==null&&o===a,l=o!==null?`${String.fromCharCode(65+o)} \u2013 ${r[o]||""}`:"Not answered",w=a!==null?`${String.fromCharCode(65+a)} \u2013 ${r[a]||""}`:"";let b=`
          <div class="wqb-review-header">
              <h2>Review Incorrect Questions</h2>
              <div class="wqb-question-counter">Question ${t+1} of ${s.totalQuestions}</div>
          </div>
          
          <div class="wqb-question-prompt">${e.prompt}</div>
          <div class="wqb-answer-options">`;e.options.forEach((_,u)=>{let v="wqb-option";u===e.correct_choice_index?v+=" correct-answer":u===e.user_answer_index&&(v+=" incorrect-answer"),b+=`<div class="${v}">
                              <input type="radio" disabled ${u===e.user_answer_index?"checked":""}>
                              <span class="wqb-option-letter">${String.fromCharCode(65+u)}</span>
                              <span class="wqb-option-text">${_}</span>
                          </div>`}),b+=`</div>
                      <div class="wqb-question-analytics">
                        <h4>Your Answer Analysis</h4>
                        <div class="wqb-analytics-grid">
                          <div class="wqb-analytics-item">
                            <span class="wqb-analytics-label">Your Answer:</span>
                            <span class="wqb-analytics-value ${c?"correct":"incorrect"}">${l}</span>
                          </div>
                          <div class="wqb-analytics-item">
                            <span class="wqb-analytics-label">Correct Answer:</span>
                            <span class="wqb-analytics-value correct">${w}</span>
                          </div>
                          <div class="wqb-analytics-item wqb-analytics-full">
                            <span class="wqb-analytics-label">Explanation:</span>
                            <div class="wqb-analytics-explanation">${e.explanation}</div>
                          </div>
                        </div>
                      </div>
                      <div class="wqb-review-footer">
                          ${x()}
                      </div>
                  </div>`,n.find(".wqb-review-main-content .wqb-review-view").html(b)}function x(){const t=s.currentIndex===0,e=s.currentIndex===s.totalQuestions-1;let r='<div class="wqb-navigation-buttons">';return t?r+='<button class="wqb-button-secondary" disabled>Previous</button>':r+='<button id="wqb-review-prev" class="wqb-button-secondary">Previous</button>',e?r+='<button id="wqb-review-return-dashboard" class="wqb-button-primary">Return to Home</button>':r+='<button id="wqb-review-next" class="wqb-button-primary">Next</button>',r+="</div>",r}function p(t){let e=s.currentIndex;t==="next"?e++:t==="prev"&&e--,e>=0&&e<s.totalQuestions?g(e):e>=s.totalQuestions&&i("#wqb-review-return-dashboard").click()}function C(){confirm("WARNING: This will permanently delete ALL your question progress data (correct/incorrect answers) for all questions. This action cannot be undone. Are you absolutely sure you want to proceed?")&&(n.find(".wqb-review-main-content .wqb-review-view").html('<div class="wqb-loader">Resetting your progress...</div>'),i.ajax({url:h,type:"POST",data:{action:"wqb_reset_user_progress",nonce:q},dataType:"json",success:e=>{var r;e.success?(alert("Your progress has been successfully reset!"),window.location.reload()):(alert("Failed to reset progress: "+(((r=e.data)==null?void 0:r.message)||"Unknown error.")),d())},error:(e,r,o)=>{console.error("AJAX Error resetting progress:",{xhr:e,status:r,error:o}),alert("A network error occurred while trying to reset progress. Please try again."),d()}}))}y()});
