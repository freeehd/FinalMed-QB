const CalHeatmap=window.CalHeatmap,dayjs=window.dayjs,heatmapInstances=new Map,activeResizeHandlers=new Map,containerObservers=new Map;function waitForFontsReady(){var t;return(t=document.fonts)!=null&&t.ready?document.fonts.ready.catch(()=>{}):Promise.resolve()}function waitForStableWidth(t,e=1e3){return new Promise(o=>{const n=Date.now();let s=0,i=0,a=0;const c=3,r=()=>{const l=t.getBoundingClientRect(),d=l.width||t.clientWidth||0,u=l.height||t.clientHeight||0;if(d>0&&Math.abs(d-s)<2&&Math.abs(u-i)<2?a++:a=0,s=d,i=u,a>=c||Date.now()-n>e){o({width:d,height:u});return}requestAnimationFrame(r)};requestAnimationFrame(r)})}function getResponsiveConfig(t,e){const o=Math.min(t||e,e),n=/iPhone|iPad|iPod|Android/i.test(navigator.userAgent),s=window.innerHeight>window.innerWidth,i=Math.max(12,Math.min(28,Math.floor((o-20)/28)));if(n&&s&&o<=480){const a=Math.floor(o*.95/17.5);return{monthsToShow:Math.max(2,Math.floor(o/140)),subDomainWidth:Math.max(14,Math.min(20,a)),subDomainHeight:Math.max(14,Math.min(20,a)),subDomainRadius:2,subDomainGutter:Math.max(2,Math.floor(a*.15)),domainLabelText:"MMM",tooltipCompact:!0,breakpoint:"mobile-portrait"}}if(n&&!s&&o<=850){const a=Math.floor(o*.95/28);return{monthsToShow:Math.max(3,Math.floor(o/120)),subDomainWidth:Math.max(12,Math.min(18,a)),subDomainHeight:Math.max(12,Math.min(18,a)),subDomainRadius:2,subDomainGutter:Math.max(2,Math.floor(a*.15)),domainLabelText:"MMM",tooltipCompact:!0,breakpoint:"mobile-landscape"}}return o<=480?{monthsToShow:3,subDomainWidth:16,subDomainHeight:16,subDomainRadius:2,subDomainGutter:2,domainLabelText:"MMM",tooltipCompact:!0,breakpoint:"sm"}:o<=768?{monthsToShow:4,subDomainWidth:16,subDomainHeight:16,subDomainRadius:2,subDomainGutter:3,domainLabelText:"MMM",tooltipCompact:!0,breakpoint:"md"}:o<=1024?{monthsToShow:5,subDomainWidth:18,subDomainHeight:18,subDomainRadius:3,subDomainGutter:3,domainLabelText:"MMM YYYY",tooltipCompact:!1,breakpoint:"lg"}:{monthsToShow:Math.min(6,Math.floor(o/180)),subDomainWidth:20,subDomainHeight:20,subDomainRadius:3,subDomainGutter:4,domainLabelText:"MMM YYYY",tooltipCompact:!1,breakpoint:"xl"}}function highlightToday(t){const e=t==null?void 0:t.querySelector("svg");if(!e)return;const o=(dayjs?dayjs():new Date).toISOString().split("T")[0],n=[`rect[data-iso-date="${o}"]`,`rect[data-date="${o}"]`,`rect[aria-label*="${o}"]`];for(const s of n){const i=e.querySelector(s);if(i){i.classList.add("wqb-today");return}}}function createTooltipContent(t,e,o=!1){const n=dayjs?dayjs(t):new Date(t),s=dayjs?o?n.format("MMM D, YYYY"):n.format("dddd, MMMM D, YYYY"):n.toLocaleDateString(),i=e.find(m=>{const p=dayjs?dayjs(m.date):new Date(m.date);return dayjs?p.isSame(n,"day"):p.toDateString()===n.toDateString()}),a=(i==null?void 0:i.total)||0,c=(i==null?void 0:i.correct)||0,r=(i==null?void 0:i.incorrect)||0,l=a>0?Math.round(c/a*100):0;if(a===0)return`<div class="wqb-tooltip-content">
              <div class="wqb-tooltip-header">${s}</div>
              <div class="wqb-tooltip-no-activity">No activity</div>
            </div>`;const d=o?"wqb-tooltip-compact":"",u=o?`<div class="wqb-tooltip-stat"><span class="wqb-tooltip-icon">\u{1F4CA}</span> ${a}</div>
       <div class="wqb-tooltip-stat wqb-tooltip-correct"><span class="wqb-tooltip-icon">\u2705</span> ${c}</div>
       <div class="wqb-tooltip-stat wqb-tooltip-incorrect"><span class="wqb-tooltip-icon">\u274C</span> ${r}</div>
       <div class="wqb-tooltip-stat"><span class="wqb-tooltip-icon">\u{1F4C8}</span> ${l}%</div>`:`<div class="wqb-tooltip-stat"><span class="wqb-tooltip-icon">\u{1F4CA}</span> Total: <span class="wqb-tooltip-value">${a}</span></div>
       <div class="wqb-tooltip-stat wqb-tooltip-correct"><span class="wqb-tooltip-icon">\u2705</span> Correct: <span class="wqb-tooltip-value">${c}</span></div>
       <div class="wqb-tooltip-stat wqb-tooltip-incorrect"><span class="wqb-tooltip-icon">\u274C</span> Incorrect: <span class="wqb-tooltip-value">${r}</span></div>
       <div class="wqb-tooltip-stat"><span class="wqb-tooltip-icon">\u{1F4C8}</span> Accuracy: <span class="wqb-tooltip-value">${l}%</span></div>`;return`<div class="wqb-tooltip-content ${d}">
            <div class="wqb-tooltip-header">${s}</div>
            <div class="wqb-tooltip-stats">${u}</div>
          </div>`}function cleanupExistingInstance(t){var s,i;const e=heatmapInstances.get(t);if(e){try{(s=e.cal)==null||s.destroy(),(i=e.cleanup)==null||i.call(e)}catch(a){console.warn("Error cleaning up heatmap instance:",a)}heatmapInstances.delete(t)}const o=containerObservers.get(t);o&&(o.disconnect(),containerObservers.delete(t));const n=document.querySelector(t);n&&(n.innerHTML="",n.style.opacity="0")}async function initializeHeatmap(t){const{itemSelector:e,heatmapData:o=[],colorDomain:n=[1,20,50,100],forceResponsive:s=!0,useContainerSize:i=!0}=t;if(!CalHeatmap)throw new Error("CalHeatmap library not loaded");const a=document.querySelector(e);if(!a)throw new Error(`Container not found: ${e}`);cleanupExistingInstance(e),a.style.minHeight="150px",await waitForFontsReady();const{width:c}=await waitForStableWidth(a),r=s?getResponsiveConfig(c,window.innerWidth):{},l=dayjs().startOf("day"),d=dayjs().subtract(r.monthsToShow||6,"month").startOf("day"),u=new CalHeatmap,m={itemSelector:e,domain:{type:"month",label:{text:r.domainLabelText,textAlign:"start",position:"top"}},subDomain:{type:"ghDay",radius:r.subDomainRadius,width:r.subDomainWidth,height:r.subDomainHeight,gutter:r.subDomainGutter},data:{source:o,x:"date",y:"total"},date:{start:d.toDate(),end:l.toDate(),highlight:[dayjs().toDate()],locale:"en"},range:(r.monthsToShow||6)+1,scale:{color:{type:"threshold",range:["#ebedf0","#c6e48b","#7bc96f","#23a3b","#196127"],domain:n}}},p=[];window.Tooltip&&window.Popper&&dayjs&&p.push([window.Tooltip,{text:(h,b,f)=>createTooltipContent(f||h,o,r.tooltipCompact)}]),await u.paint(m,p),requestAnimationFrame(()=>{const h=a.querySelector("svg");if(h)try{const b=h.getBBox();b.width&&b.height&&(h.setAttribute("viewBox",`0 -5 ${b.width} ${b.height+10}`),h.removeAttribute("width"),h.removeAttribute("height"))}catch(b){console.warn("Could not get BBox of SVG.",b)}highlightToday(a),a.style.transition="opacity 0.3s ease-in-out",a.style.opacity="1"});const w=setupResponsiveHandlers(e,o,t);return heatmapInstances.set(e,{cal:u,cleanup:w,config:r,lastWidth:c}),heatmapInstances.get(e)}function setupResponsiveHandlers(t,e,o={}){const n=document.querySelector(t);if(!n)return()=>{};let s,i=!1;const a=()=>{i||(clearTimeout(s),s=setTimeout(()=>{const l=heatmapInstances.get(t);if(!l)return;const d=n.getBoundingClientRect().width,u=Math.abs(d-l.lastWidth);(getResponsiveConfig(d,window.innerWidth).breakpoint!==l.config.breakpoint||u>100)&&(i=!0,initializeHeatmap({itemSelector:t,heatmapData:e,...o}).catch(p=>console.error("Error re-initializing heatmap",p)).finally(()=>{i=!1}))},300))},c=new ResizeObserver(a);c.observe(n),containerObservers.set(t,c);const r=()=>{c.disconnect(),containerObservers.delete(t),clearTimeout(s)};return activeResizeHandlers.set(t,r),r}function cleanupAllHeatmaps(){heatmapInstances.forEach((t,e)=>cleanupExistingInstance(e))}function createHeatmapInitializer(t){return e=>initializeHeatmap({itemSelector:t,heatmapData:e,forceResponsive:!0,useContainerSize:!0})}window.WQBHeatmapUtils={initializeHeatmap,cleanupAllHeatmaps,initializeDashboardHeatmap:createHeatmapInitializer("#wqb-cal-heatmap"),initializeLobbyHeatmap:createHeatmapInitializer("#wqb-lobby-cal-heatmap"),initializeStandaloneHeatmap:createHeatmapInitializer("#wqb-standalone-cal-heatmap")},window.addEventListener("beforeunload",cleanupAllHeatmaps);
