const jQuery=window.jQuery;jQuery(document).ready(b=>{const u=b("#wqb-review-practice-root"),h=window.wqb_data.ajax_url,y=window.wqb_data.nonce,s={questions:[],userAnswers:{},questionStates:{},totalQuestions:0,expandedQuestions:new Set};function x(e){if(!e||e.trim()==="")return"No explanation available.";const n=e.split(`
`).filter(t=>t.trim()!=="");let i="";return n.forEach((t,o)=>{const a=t.trim();if(o===0){const r=a.replace(/(Correct answer: [A-E]\))/,"<strong>$1</strong>");i+=`<div class="explanation-block correct-answer"><span class="explanation-icon">\u2705</span><div class="explanation-text">${r}</div></div>`}else{const r=a.match(/^(?:<p>)?(?:❌\s*)?([A-E]\))(.+)/);let c;if(r){const w=r[1],p=r[2];c=`<strong>${w}</strong>${p}`}else c=a.replace(/^❌\s*/,"");i+=`<div class="explanation-block incorrect-answer"><span class="explanation-icon">\u274C</span><div class="explanation-text">${c}</div></div>`}}),i}u.on("click","#wqb-review-return-lobby",()=>{window.location.href="/staging-area"}),u.on("click",".wqb-review-question-btn",function(){const e=b(this).data("question-index");E(e)});function A(){const e=sessionStorage.getItem("wqb_review_data");if(!e){f();return}try{const n=JSON.parse(e);if(console.log("Parsed review data:",n),s.questions=n.question_ids||[],s.userAnswers=n.user_answers||{},s.questionStates=n.question_states||{},s.totalQuestions=n.total_questions||s.questions.length,console.log("Review data loaded:",{questionsCount:s.questions.length,totalQuestions:s.totalQuestions,userAnswersCount:Object.keys(s.userAnswers).length,questionStatesCount:Object.keys(s.questionStates).length}),s.questions.filter(t=>s.userAnswers.hasOwnProperty(t)).length===0){f();return}Q()}catch(n){console.error("Error parsing review data:",n),f()}}function f(){u.html(`
      <div class="wqb-review-empty">
        <h2>No Review Data Available</h2>
        <p>No practice test data found for review. Please complete a practice test first.</p>
        <button id="wqb-review-return-lobby" class="wqb-button-primary">Return to Home</button>
      </div>
    `)}function Q(){u.html(`
      <div class="wqb-review-page-container">
        <div class="wqb-breadcrumb-navigation">
          <div class="wqb-breadcrumb-container">
                         <button class="wqb-breadcrumb-btn wqb-button-secondary" onclick="window.location.href='/staging-area'">
              <span class="wqb-button-icon">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <polyline points="9,22 9,12 15,12 15,22" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </span>
              Home
            </button>
            <div class="wqb-breadcrumb-separator">\u203A</div>
            <span class="wqb-breadcrumb-current">Practice Review</span>
          </div>
        </div>
        
        <div class="wqb-review-header">
          <h2>Practice Test Review</h2>
          <p>Review your answers and explanations</p>
          <button id="wqb-review-return-lobby" class="wqb-button-secondary">Return to Home</button>
        </div>
        <div class="wqb-review-questions-list">
          <!-- Questions list will be populated here -->
        </div>
      </div>
    `),_()}function _(){const i=`
      <div class="wqb-review-questions-container">
        ${s.questions.filter(t=>s.userAnswers.hasOwnProperty(t)).map((t,o)=>{const a=s.userAnswers[t],r=s.questionStates[t],c=s.expandedQuestions.has(o);let w="",p="";return r==="correct"?(w="correct",p="Correct"):r==="incorrect"&&(w="incorrect",p="Incorrect"),`
        <div class="wqb-review-question-item" data-question-id="${t}" data-question-index="${o}">
          <div class="wqb-question-summary">
            <div class="wqb-question-info">
              <span class="wqb-question-number">Question ${o+1}</span>
              <span class="wqb-question-preview">Loading question preview...</span>
              <span class="wqb-question-status ${w}">${p}</span>
            </div>
            <button class="wqb-review-question-btn" data-question-index="${o}">
              ${c?"Hide Details":"Review"}
            </button>
          </div>
          <div class="wqb-question-details ${c?"expanded":""}" style="display: ${c?"block":"none"};">
            <div class="wqb-question-loading">Loading question details...</div>
          </div>
        </div>
      `}).join("")}
      </div>
    `;u.find(".wqb-review-questions-list").html(i),C()}function C(){s.questions.filter(n=>s.userAnswers.hasOwnProperty(n)).forEach((n,i)=>{b.ajax({url:h,type:"POST",data:{action:"wqb_get_practice_review_question",nonce:y,question_id:n},dataType:"json",success:t=>{t.success?k(i,t.data):console.error("Error loading question preview:",t.data.message)},error:(t,o,a)=>{console.error("AJAX error loading question preview:",a)}})})}function k(e,n){const i=n.question.prompt.substring(0,100)+(n.question.prompt.length>100?"...":""),t=u.find(`[data-question-index="${e}"]`);t.length&&t.find(".wqb-question-preview").text(i)}function E(e){const n=s.expandedQuestions.has(e),i=u.find(`[data-question-index="${e}"]`),t=i.find(".wqb-question-details"),o=i.find(".wqb-review-question-btn");n?(s.expandedQuestions.delete(e),t.slideUp(300),o.text("Review")):(s.expandedQuestions.add(e),o.text("Hide Details"),t.find(".wqb-question-loading").length>0?P(e):t.slideDown(300))}function P(e){const n=s.questions.filter(a=>s.userAnswers.hasOwnProperty(a));if(e<0||e>=n.length)return;const i=n[e],o=u.find(`[data-question-index="${e}"]`).find(".wqb-question-details");b.ajax({url:h,type:"POST",data:{action:"wqb_get_practice_review_question",nonce:y,question_id:i},dataType:"json",success:a=>{a.success?S(a.data,e,o):(console.error("Error loading question details:",a.data.message),o.html('<div class="wqb-question-error">Error loading question details</div>'))},error:(a,r,c)=>{console.error("AJAX error loading question details:",c),o.html('<div class="wqb-question-error">Error loading question details</div>')}})}function S(e,n,i){const t=parseInt(e.user_answer_index,10),o=e.is_correct,a=parseInt(e.correct_choice_index,10),r=e.answer_distribution,c=Array.isArray(e.question.options)?e.question.options:[],w=Number.isInteger(t)?`${String.fromCharCode(65+t)} \u2013 ${c[t]||""}`:"Not answered",p=`${String.fromCharCode(65+a)} \u2013 ${c[a]||""}`;let m=`
      <div class="wqb-question-full-content">
        <div class="wqb-question-prompt">${e.question.prompt}</div>
        <div class="wqb-answer-options">`;if(e.question.options.forEach((l,d)=>{let q="wqb-option";d===a?q+=" correct-answer":d===t&&!o&&(q+=" incorrect-answer"),m+=`
        <label class="${q}">
          <input type="radio" disabled ${d===t?"checked":""}>
          <span class="wqb-option-letter">${String.fromCharCode(65+d)}</span>
          <span class="wqb-option-text">${l}</span>
          <div class="wqb-option-distribution">
            <div class="wqb-distribution-bar-container">
              <div class="wqb-distribution-bar" data-option="${d}"></div>
            </div>
            <span class="wqb-distribution-percentage" data-option="${d}"></span>
          </div>
        </label>
      `}),m+=`</div>
      
      <div class="wqb-question-analytics">
        <h4>Your Answer Analysis</h4>
        <div class="wqb-analytics-grid">
          <div class="wqb-analytics-item">
            <span class="wqb-analytics-label">Your Answer:</span>
            <span class="wqb-analytics-value ${o?"correct":"incorrect"}">${w}</span>
          </div>
          <div class="wqb-analytics-item">
            <span class="wqb-analytics-label">Correct Answer:</span>
            <span class="wqb-analytics-value correct">${p}</span>
          </div>
          <div class="wqb-analytics-item wqb-analytics-full">
            <span class="wqb-analytics-label">Explanation:</span>
<div class="wqb-analytics-explanation">${x(e.explanation)}</div>
          </div>
        </div>
      </div>
    </div>`,i.html(m),r&&Object.keys(r).length>0){i.find(".wqb-option-distribution").css("display","flex");for(let l=0;l<5;l++){const d=r[l]||{count:0,correct_count:0,percentage:0},q=l===a,$=l===t;let g="#6c757d";q?g="#28a745":$&&!o&&(g="#dc3545"),i.find(`.wqb-distribution-bar[data-option="${l}"]`).css({width:`${d.percentage}%`,"background-color":g});const v=i.find(`.wqb-distribution-percentage[data-option="${l}"]`);v.text(`${d.percentage}%`),v.removeClass("correct incorrect"),q?v.addClass("correct"):$&&!o&&v.addClass("incorrect")}}i.slideDown(300)}A()});
